name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Validate with TypeScript validator
  validate-schemas-typescript:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install -g tsx
          # scripts/validate-test-vectors.ts imports both ajv and ajv-formats
          npm install ajv ajv-formats

      - name: Run test vector validation (TypeScript)
        run: |
          tsx scripts/validate-test-vectors.ts --level 3 --verbose
          # CEP streaming vectors (events + terminal envelope)
          tsx scripts/validate-stream-vectors.ts --level 3 --verbose
          # CEP registry vectors (index + entries)
          tsx scripts/validate-registry-vectors.ts --level 3 --verbose

  # Build and test Node.js CLI
  test-node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Upgrade npm (lockfile compatibility)
        run: |
          npm install -g npm@11.6.2
          npm --version

      - name: Install dependencies
        working-directory: packages/cli-node
        run: |
          node --version
          npm --version
          npm ci --no-audit --no-fund --loglevel verbose || (
            echo "npm ci failed, dumping latest npm debug log..."
            ls -la ~/.npm/_logs || true
            LOG="$(ls -t ~/.npm/_logs/*debug-0.log 2>/dev/null | head -1 || true)"
            echo "LOG=${LOG}"
            if [ -n "${LOG}" ] && [ -f "${LOG}" ]; then
              sed -n '1,200p' "${LOG}" || true
              echo "..."
              tail -n 200 "${LOG}" || true
            fi
            exit 1
          )

      - name: Run TypeScript type check
        working-directory: packages/cli-node
        run: npx tsc --noEmit

      - name: Run tests
        working-directory: packages/cli-node
        run: npm test
