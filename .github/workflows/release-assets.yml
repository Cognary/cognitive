name: Build Registry Release Assets

on:
  release:
    types: [published]

jobs:
  registry-assets:
    runs-on: ubuntu-latest
    # Only run for runtime tags like vX.Y.Z.
    if: startsWith(github.event.release.tag_name, 'v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: packages/cli-node/package-lock.json

      - name: Install CLI Dependencies
        working-directory: packages/cli-node
        run: npm ci --no-audit --no-fund

      - name: Build CLI
        working-directory: packages/cli-node
        run: npm run build

      - name: Release Sanity Check (Versions Must Match Tag)
        run: node scripts/release/check-release.js --tag "${{ github.event.release.tag_name }}"

      - name: Build Registry Tarballs + Index
        run: |
          node packages/cli-node/dist/cli.js registry build \
            --tag "${{ github.event.release.tag_name }}" \
            --timestamp "${{ github.event.release.published_at }}"

      - name: Verify Registry Tarballs Match Index
        run: |
          node packages/cli-node/dist/cli.js registry verify \
            --index cognitive-registry.v2.json \
            --assets-dir dist/registry-assets

      - name: Upload release assets (tarballs + registry index)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/registry-assets/*.tar.gz
            cognitive-registry.v2.json
